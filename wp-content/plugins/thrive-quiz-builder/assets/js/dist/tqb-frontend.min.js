/*! Thrive Quiz Builder - 2017-02-15
* http://www.thrivethemes.com/
* Copyright (c) 2017 Thrive Themes */
var ThriveQuizB=ThriveQuizB||{};ThriveQuizB.models=ThriveQuizB.models||{},ThriveQuizB.collections=ThriveQuizB.collections||{},function(a){a(function(){ThriveQuizB.models.Base=Backbone.Model.extend({idAttribute:"ID",validation_error:function(a,b){return{field:a,message:b}},custom_action:function(a,b,c){b||(b={});var d=_.extend({type:"post",dataType:"json",url:this.url()+"&custom_action="+c,data:b},a);return jQuery.ajax(d)}}),ThriveQuizB.collections.Base=Backbone.Collection.extend({last:function(){return this.at(this.size()-1)}}),ThriveQuizB.models.Shortcode=ThriveQuizB.models.Base.extend({idAttribute:"id",defaults:{id:null,quiz_id:null,user_unique:null,page_type:"",page:{page_id:null,variation_id:null,html:"",css:"",fonts:""},question:null},url:function(){return ThriveQuizB.ajaxurl("&route=shortcode")},logSocialShareConversion:function(a,b){this.custom_action(a,b,"log_social_share_conversion")},saveUserCustomSocialShareBadge:function(a,b){this.custom_action(a,b,"save_user_custom_social_share_badge")}}),ThriveQuizB.models.Question=ThriveQuizB.models.Base.extend({idAttribute:"id",defaults:{id:null,question_id:null,type:null,text:"",image:"",description:""},get_image:function(){return"string"==typeof this.get("image")?this.get("image"):this.get("image").sizes.full.url}}),ThriveQuizB.models.Answer=ThriveQuizB.models.Base.extend({idAttribute:"id",defaults:{id:null,order:null,text:"",image:""},get_image:function(){return"string"==typeof this.get("image")?this.get("image"):this.get("image").sizes.full.url}}),ThriveQuizB.collections.Shortcodes=ThriveQuizB.collections.Base.extend({model:ThriveQuizB.models.Shortcode}),ThriveQuizB.collections.Answers=ThriveQuizB.collections.Base.extend({model:ThriveQuizB.models.Answer})})}(jQuery);var ThriveQuizB=ThriveQuizB||{};ThriveQuizB.views=ThriveQuizB.views||{},function(a){a(function(){ThriveQuizB.views.Base=Backbone.View.extend({render:function(){return this}}),ThriveQuizB.views.ShortcodeList=ThriveQuizB.views.Base.extend({events:{},el:a("body"),render:function(){this.collection.each(this.renderOne,this)},renderOne:function(a){if(a.get("page").html||a.get("question")){var b=new ThriveQuizB.views.Shortcode({model:a,collection:this.collection,el:this.$el.find("#tqb-shortcode-wrapper-"+a.get("quiz_id")+"-"+a.get("id"))});b.render()}a.get("error")&&TQB_Front.is_preview&&this.$el.find("#tqb-shortcode-wrapper-"+a.get("quiz_id")+"-"+a.get("id")).find(".tqb-frontend-error-message").html(a.get("error"))}}),ThriveQuizB.views.Shortcode=ThriveQuizB.views.Base.extend({events:{"click .tqb-shortcode-new-content .tqb-shortcode-submit-action":"nextPage","click .tqb-shortcode-new-content .tve_evt_manager_listen":"runEvent"},to_load:0,powered_by_tqb:ThriveQuizB.tpl("powered-by-thrive-themes"),render:function(){return this.showLoader(),this.loadScripts(),this.initListeners(this.model),this.hideLoader(),this},loadScripts:function(){var b=this,c=[];this.$el.find(".tqb-shortcode-new-content").html(""),this.model.get("page")&&(c=c.concat(this.model.get("page").css),c=c.concat(this.model.get("page").fonts)),this.model.get("question")&&(c=c.concat(this.model.get("question").css)),this.to_load=c.length,_.each(c,function(c,d,e){var f=a('<link rel="stylesheet" type="text/css" media="all" href="'+c+'">');this.$el.find(".tqb-shortcode-new-content").append(f),f.load(function(){b.to_load--})},this),this.check_loaded()},loadHTML:function(){var a=this;_.isEmpty(this.model.get("page"))?(this.template=ThriveQuizB.tpl("question-wrapper"),this.$el.find(".tqb-shortcode-new-content").append(this.template()),this.renderQuestion(),TQB_Front.settings.tqb_promotion_badge&&this.$el.find(".tqb-shortcode-new-content .tqb-question-wrapper").append(this.powered_by_tqb()),this.model.trigger("tqb:close_loader",this.model)):(this.template=_.template(this.model.get("page").html),this.$el.find(".tqb-shortcode-new-content").append(this.template(this.model.toJSON())),this.$el.find(".tqb-shortcode-new-content").append('<style type="text/css">'+this.model.get("page").user_css.replace(/\\/g,"")+"</style>"),this.setUserIdentifier(),this.listener(),TQB_Front.settings.tqb_promotion_badge&&this.$el.find(".tqb-shortcode-new-content .tve-tqb-page-type").append(this.powered_by_tqb()),"results"===this.model.get("page_type")?this.resultPageListener():this.model.trigger("tqb:close_loader",this.model)),setTimeout(function(){a.setOverlayHeight()},500),TCB_Front.event_triggers(ThriveGlobal.$j(this.$el)),TCB_Front.onDOMReady(),ThriveGlobal.$j(TCB_Front).trigger("content_loaded.thrive",[this.$el.find(".tqb-shortcode-new-content")])},check_loaded:function(){var a,b=this;return 0===this.to_load?(this.loadHTML(),void clearTimeout(a)):void(a=setTimeout(function(){b.check_loaded()},50))},runEvent:function(b){b.preventDefault();for(var c=a(b.currentTarget).attr("data-tcb-events"),d=!1,e=ThriveGlobal.$j.parseJSON(c.replace("__TCB_EVENT_","").replace("_TNEVE_BCT__","")),f=0,g=e.length;g>f;f++)"thrive_quiz_next_step"===e[f].a&&(d=!0);d&&this.shortcodeAction()},setUserIdentifier:function(){this.$el.find(".tqb-hidden-form-info.tqb-hidden-user-unique").val(this.model.get("user_unique"))},setOverlayHeight:function(){var a=this.$el.find(".tqb-shortcode-new-content").outerHeight();console.log(a),this.$el.find(".tqb-loading-overlay").attr("style","height:"+a+"px;")},listener:function(){var a=this;ThriveGlobal.$j(this.$el).off("lead_conversion_success.tcb").on("lead_conversion_success.tcb",".thrv_lead_generation",function(b){b.content_unlocked="results"!==a.model.get("page_type"),a.nextPage()}),ThriveGlobal.$j(this.$el).off("should_submit_form.tcb").on("should_submit_form.tcb",".thrv_lead_generation",function(a){return a.flag_need_data=!0,!0})},switchContent:function(){var a=this.$el.find(".tqb-shortcode-old-content"),b=this.$el.find(".tqb-shortcode-new-content");a.html(b.html())},nextPage:function(){this.shortcodeAction()},shortcodeAction:function(a){if("results"!=this.model.get("page_type")){if(this.hideErrorToast(),this.model.trigger("tqb:show_loader",this.model),a)var b=this.getQuestionData(a);else var b=this.getPageData();if(b){var c=this;this.model.fetch({data:b,success:function(a,b,d){c.render()},error:function(a,b,c){}})}}},hideErrorToast:function(){a("#tve-lg-error-container").hide()},getQuestionData:function(a){return{user_unique:this.model.get("user_unique"),quiz_id:this.model.get("quiz_id"),page_type:this.model.get("page_type"),answer_id:a.get("id")}},getPageData:function(){return{user_unique:this.model.get("user_unique"),quiz_id:this.model.get("quiz_id"),page_type:this.model.get("page_type"),variation:{page_id:this.model.get("page").page_id,id:this.model.get("page").variation_id}}},renderQuestion:function(){var a=new ThriveQuizB.collections.Answers(this.model.get("question").answers),b=this;a.on("tqb:answer_question",function(a){b.shortcodeAction(a)});var c=new ThriveQuizB.views.Question({model:new ThriveQuizB.models.Question(this.model.get("question").data),collection:a,el:this.$el.find(".tqb-shortcode-new-content .tqb-question-wrapper")});return c.render()},resultPageListener:function(){var b=this;if(b.model.get("page").has_social_badge&&1==b.model.get("page").has_social_badge&&b.model.get("page").html_canvas){var c=300,d=b.$el.find(".tve_editor_main_content")[0].offsetWidth-80,e=a('<div id="tie-html-canvas" style="overflow: visible; position: absolute; z-index: -1; visibility: hidden;">'+b.model.get("page").html_canvas+"</div>"),f=a('<div id="tie-preloader-gif" style="background-image: url(\''+b.model.get("page").social_loader_url+"'); background-repeat: no-repeat; background-position: center center;background-color: #e8e8e8; width: "+d+"px; max-width: 100%; height: "+c+'px ;"></div>');b.$el.find(".tqb-shortcode-new-content").parents().each(function(b,c){a(c).addClass("tqb-overflow-visible-badge")}),b.$el.find(".tqb-shortcode-new-content").prepend(e),b.$el.find(".tqb-social-share-badge-container  img").removeAttr("src"),b.$el.find(".tqb-social-share-badge-container").children().hide(),b.$el.find(".tqb-social-share-badge-container").append(f),html2canvas([e.get(0)],{onrendered:function(c){var d=c.toDataURL("image/png"),g=d.replace(/^data:image\/(png|jpg);base64,/,"");b.$el.find(".tqb-shortcode-new-content").parents().each(function(b,c){a(c).removeClass("tqb-overflow-visible-badge")}),b.model.saveUserCustomSocialShareBadge({success:function(a){b.$el.find(".tqb-social-share-badge-container  img").attr("src",a),b.$el.find(".tqb-social-share-badge-container  .tve_s_fb_share").attr("data-image",a),ThriveGlobal.$j(tve_frontend_options.is_editor_page?"#tve_editor":"body").on("click",".tqb-social-share-badge-container .tve_s_link",function(){b.model.logSocialShareConversion({},{page_id:b.model.get("page").page_id,quiz_id:b.model.get("page").quiz_id,variation_id:b.model.get("page").variation_id,"tqb-variation-user_unique":b.model.get("user_unique")});var a=ThriveGlobal.$j(this).parents(".tve_s_item"),c=a.attr("data-s");TCB_Front.onSocialCustomClick[c]&&TCB_Front.onSocialCustomClick[c](a)}),e.remove(),b.$el.find(".tqb-social-share-badge-container  img").load(function(){f.remove(),b.$el.find(".tqb-social-share-badge-container").children().show()})},complete:function(){b.model.trigger("tqb:close_loader",b.model)}},{img_data:g,quiz_id:b.model.get("quiz_id"),user_id:b.model.get("user_id"),result:b.model.get("page").result})}})}else this.model.trigger("tqb:close_loader",this.model);ThriveGlobal.$j(tve_frontend_options.is_editor_page?"#tve_editor":"body").on("click",".thrv_social_custom .tve_s_link",function(){b.model.logSocialShareConversion({},{page_id:b.model.get("page").page_id,quiz_id:b.model.get("page").quiz_id,variation_id:b.model.get("page").variation_id,"tqb-variation-user_unique":b.model.get("user_unique")})})},showLoader:function(){this.$el.find(".tqb-loading-overlay").show(),this.$el.find(".tqb-shortcode-new-content").html("")},hideLoader:function(){this.$el.find(".tqb-loading-overlay").hide()},initListeners:function(a){var b=this;a.on("tqb:show_loader",function(a){b.showLoader()}),a.on("tqb:close_loader",function(a){b.hideLoader()})}}),ThriveQuizB.views.Question=ThriveQuizB.views.Base.extend({template:ThriveQuizB.tpl("question"),render:function(){return this.$el.html(this.template({item:this.model})),this.renderAnswers(),!0},renderAnswers:function(){var a=2==this.model.get("q_type");a&&this.$el.find(".tqb-answers-container").addClass("tqb-answer-has-image");var b=new ThriveQuizB.views.Answers({model:this.model,collection:this.collection,el:this.$el.find(".tqb-answers-container")});return b.render()}}),ThriveQuizB.views.Answers=ThriveQuizB.views.Base.extend({events:{},render:function(){return this.collection.each(this.renderOne,this),this},renderOne:function(a){var b=this;a.on("tqb:choose_answer",function(){b.collection.trigger("tqb:answer_question",a)});var c=new ThriveQuizB.views.Answer({model:a});this.$el.append(c.render(2==this.model.get("q_type")).$el)}}),ThriveQuizB.views.Answer=ThriveQuizB.views.Base.extend({className:"tqb-answer-inner-wrapper",template:ThriveQuizB.tpl("answer"),events:{"click .tqb-answer-action":"answerAction"},render:function(a){return this.template=a?ThriveQuizB.tpl("answer-image"):this.template,this.$el.html(this.template({item:this.model})),this},answerAction:function(){this.$el.find(".tqb-answer-action").addClass("tqe-selected-answer"),this.model.trigger("tqb:choose_answer",this.model)}})})}(jQuery),function(a){_.templateSettings={evaluate:/<#([\s\S]+?)#>/g,interpolate:/<#=([\s\S]+?)#>/g,escape:/<#-([\s\S]+?)#>/g},ThriveQuizB.ajaxurl=function(a){var b=-1!==TQB_Front.ajax_url.indexOf("?")?"&":"?";return a&&a.length?(a=a.replace(/^(\?|&)/,""),a+="&_nonce="+TQB_Front.nonce,a+="&tqb-post-id="+TQB_Front.post_id,TQB_Front.ajax_url+b+a):TQB_Front.ajax_url+b+"_nonce="+ThriveQuizB.admin_nonce},ThriveQuizB.tpl=function(b,c){var d=a("script#"+b.replace(/\//g,"-")).html()||"";return d=d.replace(/(\n|\t|\r)/g,""),c?_.template(d)(c):_.template(d)},a.fn.tqb=function(){var b=(new ThriveQuizB.collections.Shortcodes,{});return a(".tqb-shortcode-wrapper").each(function(c){var d=a(this).attr("data-quiz-id"),e=a(this).attr("data-unique");b[e]=d}),0===Object.keys(b).length?!1:(!window.FB&&window.tve_frontend_options.social_fb_app_id&&a.getScript("//connect.facebook.com/en_US/sdk.js",function(){FB.init({appId:window.tve_frontend_options.social_fb_app_id,xfbml:!1,version:"v2.3"})}),window.TVE_Dash&&!TVE_Dash.ajax_sent?void a(document).on("tve-dash.load",function(a){TVE_Dash.add_load_item("tqb_lazy_load",{quiz_ids:b},function(a){var b=new ThriveQuizB.collections.Shortcodes;Object.keys(a).forEach(function(c){a[c].id=c;var d=new ThriveQuizB.models.Shortcode(a[c]);b.add([d])}),ThriveQuizB.shortcode_list=new ThriveQuizB.views.ShortcodeList({collection:b}),ThriveQuizB.shortcode_list.render()})}):void 0)},a(function(){a(this).tqb()})}(jQuery);